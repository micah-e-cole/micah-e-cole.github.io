var f=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var w=(n,e)=>{for(var t in e)f(n,t,{get:e[t],enumerable:!0})},g=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of _(e))!y.call(n,i)&&i!==t&&f(n,i,{get:()=>e[i],enumerable:!(s=p(e,i))||s.enumerable});return n};var F=n=>g(f({},"__esModule",{value:!0}),n);var D={};w(D,{Context:()=>l,DEFAULT_IGNORE_SELECTORS:()=>C,DEFAULT_SELECTORS:()=>E,ESC_KEY:()=>d,Loock:()=>L,Manager:()=>c,TAB_KEY:()=>x,focusTrapMixin:()=>A,getContext:()=>k,setContext:()=>b,windowManager:()=>u});module.exports=F(D);var h=require("@chialab/dna");var m=require("@chialab/dna"),E=["button","input","select","textarea",'[contenteditable=""]','[contenteditable="true"]',"a[href]","[tabindex]","summary"],C=["details:not([open]) *:not(summary)"],v=typeof Symbol<"u"?Symbol("loock"):"__look_symbol__";function b(n,e){n[v]=e}function k(n){return n[v]}var l=class{get active(){return this._active}get disabled(){return this._disabled||!this.element.isConnected}constructor(e,t={},s){this.element=e,b(e,this),this.focusableSelectors=E,this.ignoredSelectors=C,this.dismiss=!0,this.parent=s,this._active=!1,this._currentElement=null,this._lastKeydownTime=Date.now(),this._tabIndex=e.getAttribute("tabindex")||"0",t.selectors&&this.setFocusableSelectors(t.selectors),t.ignore&&this.setIgnoredSelectors(t.ignore),t.dismiss!=null&&this.setDismiss(t.dismiss),this.onClick=i=>{if(this.disabled)return;let r=this.findFocusableChildren(),a=this.parent.root.document.activeElement;if(a&&r.indexOf(a)!==-1)return;let o=i.target;for(;e.contains(o)||o===e;){if(r.indexOf(o)!==-1){o.focus();break}if(o===e){e.focus();break}o=o.parentNode}},t.initialize!==!1&&(t.disabled?this.disable():this.enable())}setFocusableSelectors(e){if(Array.isArray(e))this.focusableSelectors=e;else if(typeof e=="string"&&e)this.focusableSelectors=e.split(",");else throw new Error("invalid selectors list")}setIgnoredSelectors(e){if(Array.isArray(e))this.ignoredSelectors=e;else if(typeof e=="string"&&e)this.ignoredSelectors=e.split(",");else throw new Error("invalid selectors list")}findFocusableChildren(){let e=this.element.querySelectorAll(this.focusableSelectors.map(i=>`${i}:not([type=hidden]):not([tabindex="-1"]):not([disabled]):not([aria-hidden]):not([display=none])`).join(", ")),t=[].slice.call(e),s=this.ignoredSelectors.length?[].slice.call(this.element.querySelectorAll(this.ignoredSelectors.join(","))):[];return t.filter(i=>!s.some(r=>i===r||r.contains(i))).filter(i=>{let{width:r,height:a}=i.getBoundingClientRect();return!!a&&!!r})}setDismiss(e){this.dismiss=e}prev(){if(this.disabled)return;let e=this.findFocusableChildren();if(!e.length){this.restore();return}let t=e.indexOf(this._currentElement);t===0?t=e.length-1:t!==-1?t=t-1:t=e.length-1,this.setCurrentElement(e[t])}next(){if(this.disabled)return;let e=this.findFocusableChildren();if(!e.length){this.restore();return}let t=e.indexOf(this._currentElement);t===e.length-1?t=0:t!==-1?t=t+1:t=0,this.setCurrentElement(e[t])}async enter(e){if(this.disabled||this.active)return;let t=this.element;this._active=!0,!t.hasAttribute("aria-label")&&!t.hasAttribute("aria-labelledby")&&!t.hasAttribute("aria-describedby")&&console.warn("created a Context without aria-label",this),await(0,m.dispatchAsyncEvent)(t,"focusenter",this),e!==this.element&&this.findFocusableChildren().indexOf(e)!==-1&&this.setCurrentElement(e,!1),this.restore()}restore(){this.disabled||(this._currentElement?this._currentElement.focus():this.element.focus())}async exit(){return this.disabled||!this.active||this.dismiss===!1||typeof this.dismiss=="function"&&await this.dismiss(this)===!1?!1:(await this.forceExit(),!0)}async forceExit(){this.disabled||(this._active=!1,this.unsetCurrentElement(!1),await(0,m.dispatchAsyncEvent)(this.element,"focusexit",this))}setCurrentElement(e,t=!0){this._currentElement=e,t&&e.focus()}unsetCurrentElement(e=!0){this._currentElement=null,e&&this.restore()}hasCurrentElement(){return this._currentElement!==null}attach(e){this.parent&&this.parent!==e&&this.detach(),this.parent=e}detach(){this.forceExit(),this.parent.removeContext(this),this.parent=null}enable(){this._disabled!==!1&&(this._disabled=!1,this.element.setAttribute("tabindex",this._tabIndex),this.element.addEventListener("click",this.onClick))}disable(){this._disabled||(this.forceExit(),this._disabled=!0,this.element.setAttribute("tabindex","-1"),this.element.removeEventListener("click",this.onClick))}};var x={key:"Tab",keyCode:"9"},d={key:"Escape",altKey:"Esc",keyCode:"27"};var S=150,c=class{constructor(e=h.window){this.root=e,this.contexts=[],this.actives=[],this.defaultContext=void 0,this.activeContext=void 0,this._activeElement=void 0,this._listeners=new WeakMap,this.onKeyDown=async t=>{if(!!this.activeContext){if(t.key==d.key||t.key==d.altKey){if(this.activeContext===this.defaultContext){this.activeContext.hasCurrentElement()&&(t.preventDefault(),this.activeContext.unsetCurrentElement());return}if(t.preventDefault(),!await this.activeContext.exit())return}else if(t.keyCode==x.keyCode){if(t.preventDefault(),Date.now()-this._lastKeydownTime<S||(this._lastKeydownTime=Date.now(),this.activeContext.findFocusableChildren().length===0&&!await this.activeContext.exit()))return;t.shiftKey?this.activeContext.prev():this.activeContext.next()}}},this.onFocusIn=({target:t})=>{let s=this.contexts.filter(i=>!i.disabled).filter(({element:i})=>i===t||i.contains(t)).sort(({element:i},{element:r})=>i.contains(r)?1:-1)[0];s?s.active?t!==s.element?s.setCurrentElement(t):s.unsetCurrentElement(!1):s.enter(t):this.activeContext&&this.activeContext.exit()},this.onIframeFocus=()=>{setTimeout(()=>{h.document.activeElement?.tagName==="IFRAME"&&this.activeContext&&this.activeContext.exit()},0)},e.addEventListener("keydown",this.onKeyDown),e.addEventListener("focusin",this.onFocusIn),e.addEventListener("focusout",this.onIframeFocus)}createDefaultContext(e,t={}){let s=this.defaultContext=this.createContext(e,t);return s.disabled||s.enter(),this.defaultContext}createContext(e,t={}){let s=new l(e,t);return this.addContext(s),s}addContext(e){this.contexts.indexOf(e)===-1&&(this.contexts.push(e),e.attach(this),e.enable(),this._listenContext(e))}_listenContext(e){let t=i=>{i.detail===e&&this.contexts.indexOf(e)!==-1&&(this._activeElement=this._activeElement||this.root.document.activeElement,this.activeContext=e,this.actives.push(e))},s=i=>{if(i.detail!==e)return;let r=e===this.activeContext,a=this.actives.indexOf(e);if(this.actives.splice(a,1),!!r){if(this.actives.length){this.activeContext=this.actives[this.actives.length-1],this.activeContext.restore();return}if(this.defaultContext!==this.activeContext){if(delete this.activeContext,this.defaultContext&&!this.defaultContext.disabled){this.defaultContext.enter();return}this._activeElement&&(this._activeElement.focus(),delete this._activeElement)}}};this._listeners.set(e,{onFocusEnter:t,onFocusExit:s}),e.element.addEventListener("focusenter",t),e.element.addEventListener("focusexit",s)}_unlistenContext(e){let t=this._listeners.get(e);t&&(e.element.removeEventListener("focusenter",t.onFocusEnter),e.element.removeEventListener("focusexit",t.onFocusExit),this._listeners.delete(e))}removeContext(e){let t=this.contexts.indexOf(e);t!==-1&&(e.disable(),this.contexts.splice(t,1),this._unlistenContext(e))}destroy(){this.contexts.forEach(e=>{this.removeContext(e)}),this.root.removeEventListener("keydown",this.onKeyDown),this.root.removeEventListener("focusin",this.onFocusIn),this.root.removeEventListener("focusout",this.onIframeFocus)}},u=new c(h.window);var A=(n,e)=>class extends n{constructor(...i){super(...i),this.context=new l(this,{dismiss:this.onFocusDismiss.bind(this),...e,initialize:!1}),this.addEventListener("focusenter",r=>{r.target===this&&this.onFocusEnter()}),this.addEventListener("focusexit",r=>{r.target===this&&this.onFocusExit()})}connectedCallback(){super.connectedCallback(),u.removeContext(this.context),this.context.enable(),u.addContext(this.context)}disconnectedCallback(){super.disconnectedCallback(),u.removeContext(this.context)}onFocusEnter(){}onFocusExit(){}onFocusDismiss(){return!0}};var L=c;0&&(module.exports={Context,DEFAULT_IGNORE_SELECTORS,DEFAULT_SELECTORS,ESC_KEY,Loock,Manager,TAB_KEY,focusTrapMixin,getContext,setContext,windowManager});
//# sourceMappingURL=loock.cjs.map
